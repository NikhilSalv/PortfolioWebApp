name: Deploy to Heroku

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build project
        run: npm run build
      
      - name: Deploy to Heroku using Platform API
        env:
          HEROKU_API_KEY: ${{secrets.HEROKU_API_KEY}}
          HEROKU_APP_NAME: ${{secrets.HEROKU_APP_NAME}}
        run: |
          # Create source tarball (excluding node_modules and build directory as Heroku will rebuild)
          tar --exclude='./node_modules' --exclude='./build' --exclude='./.git' -czf /tmp/source.tgz .
          
          # Get source blob URL
          SOURCE_BLOB_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST https://api.heroku.com/apps/$HEROKU_APP_NAME/sources \
            -H "Accept: application/vnd.heroku+json; version=3" \
            -H "Authorization: Bearer $HEROKU_API_KEY")
          
          HTTP_CODE=$(echo "$SOURCE_BLOB_RESPONSE" | tail -n1)
          SOURCE_BLOB_BODY=$(echo "$SOURCE_BLOB_RESPONSE" | sed '$d')
          
          echo "HTTP Status Code: $HTTP_CODE"
          echo "Response: $SOURCE_BLOB_BODY"
          
          if [ "$HTTP_CODE" != "201" ]; then
            echo "Error: Failed to create source blob. HTTP Status: $HTTP_CODE"
            echo "$SOURCE_BLOB_BODY"
            exit 1
          fi
          
          echo "$SOURCE_BLOB_BODY" > /tmp/source_response.json
          SOURCE_BLOB_GET_URL=$(python3 -c "import json; data=json.load(open('/tmp/source_response.json')); print(data['source_blob']['get_url'])")
          SOURCE_BLOB_PUT_URL=$(python3 -c "import json; data=json.load(open('/tmp/source_response.json')); print(data['source_blob']['put_url'])")
          
          if [ -z "$SOURCE_BLOB_GET_URL" ] || [ -z "$SOURCE_BLOB_PUT_URL" ]; then
            echo "Error: Failed to extract source blob URLs"
            cat /tmp/source_response.json
            exit 1
          fi
          
          echo "Source blob GET URL: $SOURCE_BLOB_GET_URL"
          echo "Source blob PUT URL: $SOURCE_BLOB_PUT_URL"
          
          # Upload source tarball
          curl -X PUT "$SOURCE_BLOB_PUT_URL" -H "Content-Type:" --data-binary @/tmp/source.tgz
          
          # Get commit SHA
          SOURCE_VERSION=$(git rev-parse HEAD)
          
          # Create build
          BUILD_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST https://api.heroku.com/apps/$HEROKU_APP_NAME/builds \
            -d "{\"source_blob\":{\"url\":\"$SOURCE_BLOB_GET_URL\", \"version\":\"$SOURCE_VERSION\"}}" \
            -H "Content-Type: application/json" \
            -H "Accept: application/vnd.heroku+json; version=3" \
            -H "Authorization: Bearer $HEROKU_API_KEY")
          
          BUILD_HTTP_CODE=$(echo "$BUILD_RESPONSE" | tail -n1)
          BUILD_BODY=$(echo "$BUILD_RESPONSE" | sed '$d')
          
          echo "Build HTTP Status Code: $BUILD_HTTP_CODE"
          echo "Build Response: $BUILD_BODY"
          
          if [ "$BUILD_HTTP_CODE" != "201" ] && [ "$BUILD_HTTP_CODE" != "202" ]; then
            echo "Error: Failed to create build. HTTP Status: $BUILD_HTTP_CODE"
            echo "$BUILD_BODY"
            exit 1
          fi
          
          echo "$BUILD_BODY" > /tmp/build_response.json
          BUILD_ID=$(python3 -c "import json; data=json.load(open('/tmp/build_response.json')); print(data['id'])")
          
          if [ -z "$BUILD_ID" ]; then
            echo "Error: Failed to extract build ID"
            cat /tmp/build_response.json
            exit 1
          fi
          
          echo "Build created with ID: $BUILD_ID"
          echo "Build status will be available at: https://dashboard.heroku.com/apps/$HEROKU_APP_NAME/activity/builds/$BUILD_ID"
