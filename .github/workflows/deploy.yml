name: Deploy to Heroku

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build project
        run: npm run build
      
      - name: Deploy to Heroku using Platform API
        env:
          HEROKU_API_KEY: ${{secrets.HEROKU_API_KEY}}
          HEROKU_APP_NAME: ${{secrets.HEROKU_APP_NAME}}
        run: |
          # Create source tarball (excluding node_modules and build directory as Heroku will rebuild)
          tar --exclude='./node_modules' --exclude='./build' --exclude='./.git' -czf /tmp/source.tgz .
          
          # Get source blob URL
          SOURCE_BLOB_RESPONSE=$(curl -s -n -X POST https://api.heroku.com/apps/$HEROKU_APP_NAME/sources \
            -H "Accept: application/vnd.heroku+json; version=3" \
            -H "Authorization: Bearer $HEROKU_API_KEY")
          
          echo "$SOURCE_BLOB_RESPONSE" > /tmp/source_response.json
          SOURCE_BLOB_GET_URL=$(python3 -c "import json; print(json.load(open('/tmp/source_response.json'))['source_blob']['get_url'])")
          SOURCE_BLOB_PUT_URL=$(python3 -c "import json; print(json.load(open('/tmp/source_response.json'))['source_blob']['put_url'])")
          
          # Upload source tarball
          curl -X PUT "$SOURCE_BLOB_PUT_URL" -H "Content-Type:" --data-binary @/tmp/source.tgz
          
          # Get commit SHA
          SOURCE_VERSION=$(git rev-parse HEAD)
          
          # Create build
          BUILD_RESPONSE=$(curl -s -n -X POST https://api.heroku.com/apps/$HEROKU_APP_NAME/builds \
            -d "{\"source_blob\":{\"url\":\"$SOURCE_BLOB_GET_URL\", \"version\":\"$SOURCE_VERSION\"}}" \
            -H "Content-Type: application/json" \
            -H "Accept: application/vnd.heroku+json; version=3" \
            -H "Authorization: Bearer $HEROKU_API_KEY")
          
          echo "$BUILD_RESPONSE" > /tmp/build_response.json
          BUILD_ID=$(python3 -c "import json; print(json.load(open('/tmp/build_response.json'))['id'])")
          
          echo "Build created with ID: $BUILD_ID"
          echo "Build status will be available at: https://dashboard.heroku.com/apps/$HEROKU_APP_NAME/activity/builds/$BUILD_ID"
